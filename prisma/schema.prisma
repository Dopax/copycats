generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Ad {
  id              String       @id @default(uuid())
  postId          String       @unique // The Facebook Post ID
  brand           String?
  description     String?
  headline        String?
  adLink          String?      // Facebook Ad Link
  facebookLink    String?      // Facebook Post Permalink
  videoUrl        String?      // URL to the video/image file
  thumbnailUrl    String?
  firstSeen       DateTime     @default(now())
  lastSeen        DateTime     @default(now())
  publishDate     DateTime?
  
  archived        Boolean      @default(false)
  priority        Int?         // 1=High, 2=Medium, 3=Low, null=No priority
  notes           String?
  whyItWorks      String?
  transcript      String?
  
  snapshots       AdSnapshot[]
  tags            Tag[]
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  formatId        String?
  format          AdFormat?    @relation(fields: [formatId], references: [id])
  
  hookId          String?
  hook            AdHook?      @relation(fields: [hookId], references: [id])

  themeId         String?
  theme           AdTheme?     @relation(fields: [themeId], references: [id])

  angleId         String?
  angle           AdAngle?     @relation(fields: [angleId], references: [id])

  awarenessLevelId String?
  awarenessLevel   AdAwarenessLevel? @relation(fields: [awarenessLevelId], references: [id])

  demographicId    String?
  demographic      AdDemographic?    @relation(fields: [demographicId], references: [id])

  referencedInBatches AdBatch[]
}

model AdFormat {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  audioChoice String?  // e.g. "Text Only", "Music Only", "Voice Over", "Person Talking"
  ads         Ad[]
  batches     AdBatch[]
  brandId     String?
  brand       Brand?   @relation(fields: [brandId], references: [id])
}

model AdHook {
  id           String   @id @default(uuid())
  name         String   @unique
  type         String?  // FLOATING_ELEMENTS, FB_COMMENT, TIKTOK_COMMENT, TEXT, VFX, FRAME_SELECTION, AUDIO
  content      String?  // Text content for comment/text hooks
  videoUrl     String?  // Uploaded or linked video file
  thumbnailUrl String?
  
  ads          Ad[]
  batchItems   BatchItem[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime? @updatedAt
  
  brandId      String?
  brand        Brand?    @relation(fields: [brandId], references: [id])
}


model AdTheme {
  id       String @id @default(uuid())
  name     String @unique
  description String?
  ads      Ad[]
  concepts CreativeConcept[]
  brandId  String?
  brand    Brand?   @relation(fields: [brandId], references: [id])
}

model AdAngle {
  id       String @id @default(uuid())
  name     String @unique
  category String?
  description String?
  brainClicks String?
  ads      Ad[]
  concepts CreativeConcept[]
  brandId  String?
  brand    Brand?   @relation(fields: [brandId], references: [id])
}

model AdDemographic {
  id       String @id @default(uuid())
  name     String @unique
  ads      Ad[]
  creators Creator[]
  concepts CreativeConcept[]
  brandId  String?
  brand    Brand?   @relation(fields: [brandId], references: [id])
}


model AdAwarenessLevel {
  id       String @id @default(uuid())
  name     String @unique
  ads      Ad[]
  concepts CreativeConcept[]
  brandId  String?
  brand    Brand?   @relation(fields: [brandId], references: [id])
}

model CreativeConcept {
  id            String @id @default(uuid())
  name          String
  
  angleId       String
  angle         AdAngle @relation(fields: [angleId], references: [id])
  
  themeId       String
  theme         AdTheme @relation(fields: [themeId], references: [id])
  
  demographicId String
  demographic   AdDemographic @relation(fields: [demographicId], references: [id])
  
  awarenessLevelId String
  awarenessLevel   AdAwarenessLevel @relation(fields: [awarenessLevelId], references: [id])
  
  brandId       String?
  brand         Brand?   @relation(fields: [brandId], references: [id])

  batches       AdBatch[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  conceptDoc    String?
}

model Brand {
  id        String   @id @default(uuid())
  name      String   @unique
  logoUrl   String?  // Can be an image URL or null
  color     String?  // Hex code for profile avatar background
  
  offerBrief String? // Information about the product/market/avatar for AI generation
  
  batches   AdBatch[]
  concepts  CreativeConcept[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  color2    String?  // Hex code for secondary color
  fontUrl   String?  // URL for font image/file

  assets    BrandAsset[]
  
  formats   AdFormat[]
  hooks     AdHook[]
  themes    AdTheme[]
  angles    AdAngle[]
  demographics AdDemographic[]
  awarenessLevels AdAwarenessLevel[]

  // Google Drive Integration
  googleRefreshToken String?
  googleDriveFolderId String?
  googleEmail        String?

  creators           Creator[]
  // Facebook Ads Integration
  facebookAccessToken String?
  adAccountId        String?

  creatives          Creative[]
  users              User[]
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hashed
  name      String?
  role      String @default("OWNER") // OWNER, VIDEO_EDITOR, CREATIVE_STRATEGIST, CREATOR
  
  // Relations
  brandId   String?
  brand     Brand?   @relation(fields: [brandId], references: [id])
  
  // If role is CREATOR
  creatorId String?  @unique
  creator   Creator? @relation(fields: [creatorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Creator {
  id            String   @id @default(uuid())
  name          String
  country       String?
  language      String?
  pricePerVideo Float?
  demographicId String?
  demographic   AdDemographic? @relation(fields: [demographicId], references: [id])
  collabCount   Int      @default(0)
  email         String?
  phone         String?
  socialHandle  String?
  gender        String?
  ageGroup      String?

  source        String?
  messagingPlatform String? // Upwork, Slack, Zoho, Whatsapp, Instagram, Gorgias
  paymentMethod     String? // Upwork, Paypal, Bank, Free Kit
  type          String   @default("TEMPORARY") // TEMPORARY, REPEAT, PERMANENT
  status        String   @default("APPLIED")   // APPLIED, APPROVED, REJECTED, ARCHIVED
  joinedAt      DateTime @default(now())
  
  profileImageUrl String?

  brandId       String
  brand         Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  
  // Active Batch (The job they are currently working on)
  activeBatchId Int?
  activeBatch   AdBatch? @relation("ActiveBatch", fields: [activeBatchId], references: [id])
  
  // Onboarding State
  onboardingStep   String @default("OFFER") // OFFER, ORDER, UPLOAD, COMPLETED
  magicLinkToken   String? @unique
  
  // Offer / Deal (Set by Admin)
  offerType        String?  // "FREE_KIT", "PAID"
  offerAmount      Float?   // e.g. 50.0
  productLink      String?  // Specific link for them
  couponCode       String?
  
  // Mid-Upload Tracker (CID of the current delivery session)
  activeDeliveryCid String?
  
  // Order Step (Filled by Creator)
  orderNumber      String?
  
  // System Link
  user             User?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  creatives     Creative[]
}

model BrandAsset {
  id        String   @id @default(uuid())
  brandId   String
  brand     Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  
  url       String
  name      String?
  type      String   @default("IMAGE") // IMAGE, VIDEO, etc.
  
  createdAt DateTime @default(now())
}

model AdSnapshot {
  id        String   @id @default(uuid())
  adId      String
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  
  likes     Int      @default(0)
  shares    Int      @default(0)
  comments  Int      @default(0)
  
  capturedAt DateTime @default(now())

  importBatchId String?
  importBatch   ImportBatch? @relation(fields: [importBatchId], references: [id])
}

model Tag {
  id    String @id @default(uuid())
  name  String @unique
  ads   Ad[]
  creatives Creative[]
}

model FacebookAd {
  id              String   @id // Facebook Ad ID
  name            String
  status          String
  
  // Metrics
  spend           Float    @default(0)
  roas            Float    @default(0)
  cpm             Float    @default(0)
  ctr             Float    @default(0)
  clicks          Int      @default(0)
  impressions     Int      @default(0)
  
  // Relations
  batchId         Int?
  batch           AdBatch? @relation(fields: [batchId], references: [id])
  
  updatedAt       DateTime @updatedAt
}

model AdBatch {
  id          Int      @id @default(autoincrement())
  name        String
  status      String   @default("IDEATION") // IDEATION, CREATOR_BRIEFING, FILMING, EDITOR_BRIEFING, EDITING, REVIEW, AI_BOOST, LAUNCHED, ARCHIVED
  batchType   String   // COPYCAT, NET_NEW, ITERATION
  priority    String?  // HIGH, MEDIUM, LOW

  conceptId   String
  concept     CreativeConcept @relation(fields: [conceptId], references: [id])
  
  brandId     String?
  brand       Brand?          @relation(fields: [brandId], references: [id])

  formatId    String?
  format      AdFormat? @relation(fields: [formatId], references: [id])

  assignee    String?   // Editor Name
  brief       String?   // Markdown or text (Now explicitly "Editor Brief")
  
  // Ideation
  idea        String?   // Initial Idea / Notes
  
  // Creator Briefing
  creatorBrief     String? // Instructions for Creator
  shotlist         String? // Structured shotlist
  creatorBriefType String? // GENERAL, SPECIFIC, COPYCAT

  // AI Boost Fields
  aiAdCopy      String?
  aiImagePrompt String?
  aiVideoPrompt String?

  // If Copycat or Iteration, link to an existing Ad
  referenceAdId String?
  referenceAd   Ad?     @relation(fields: [referenceAdId], references: [id])

  projectFilesUrl String? // Link to Google Drive Zip

  // Linked Facebook Ads
  facebookAds   FacebookAd[]

  items       BatchItem[]
  assignedCreators Creator[] @relation("ActiveBatch")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model BatchItem {
  id        String   @id @default(uuid())
  batchId   Int
  batch     AdBatch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  hookId    String?
  hook      AdHook?  @relation(fields: [hookId], references: [id])

  notes     String?
  script    String?
  videoUrl  String?  // Link to Google Drive Video
  status    String   @default("PENDING") // PENDING, DONE
}

model ImportBatch {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  snapshots AdSnapshot[]
}

model Creative {
  id              String   @id @default(uuid())
  brandId         String
  brand           Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  
  // Google Drive & Storage
  driveFileId     String?  @unique
  driveRevisionId String?
  driveViewLink   String?
  thumbnailUrl    String?
  folderPath      String? // e.g. "/Project A/Raw Files"
  proxyUrl        String?  // Low-res version for preview
  
  name            String
  type            String   @default("VIDEO") // VIDEO, IMAGE
  
  // Technical Metadata
  duration        Float?
  width           Int?
  height          Int?
  fps             Float?
  
  // Processing Status (for the AI Pipeline)
  processingStatus String @default("unprocessed") // unprocessed, processing, completed, failed, stale
  
  // Custom ID for Folder Structure
  cid             String?   // e.g. "C-1001", Shared by files in the same batch/delivery

  // midUploadCreators Creator[] @relation("MidUpload") -> Removed
  
  
  // Rich Metadata & Embeddings (Stored High Level)
  overallSummary  String?
  mainTopic       String?
  
  // Categorization
  product     String?
  sceneType   String?
  
  // Rich Attributes
  creatorId   String?
  creator     Creator? @relation(fields: [creatorId], references: [id])
  
  audioType   String?  // "Background Sound", "Voice Over"
  actorType   String?  // "UGC", "Hand Model"
  
  tags            Tag[]
  
  // Relations for Granular Analysis
  segments        VideoSegment[]
  transcripts     TranscriptLine[]
  detections      VisualDetection[]
  
  isFavorite      Boolean  @default(false)
  isArchived      Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model VideoSegment {
  id          String   @id @default(uuid())
  creativeId  String
  creative    Creative @relation(fields: [creativeId], references: [id], onDelete: Cascade)
  
  startTime   Float
  endTime     Float
  segmentType String   // SHOT, SCENE
  
  description String?  // AI Summary of this segment
  embedding   String?  // Vector embedding (serialized)
  
  clipperUrl  String?  // Link to generated clip if any
}

model TranscriptLine {
  id          String   @id @default(uuid())
  creativeId  String
  creative    Creative @relation(fields: [creativeId], references: [id], onDelete: Cascade)
  
  startTime   Float
  endTime     Float
  text        String
  speaker     String?
}

model VisualDetection {
  id          String   @id @default(uuid())
  creativeId  String
  creative    Creative @relation(fields: [creativeId], references: [id], onDelete: Cascade)
  
  startTime   Float
  endTime     Float
  label       String   // e.g. "Cat", "Logo", "Text"
  confidence  Float
  type        String   // OBJECT, OCR, BRAND
  box         String?  // JSON string for bounding box {x,y,w,h}
}
